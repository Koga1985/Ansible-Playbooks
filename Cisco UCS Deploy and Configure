---
- name: Deploy and configure Cisco UCS
  hosts: ucs
  gather_facts: no
  vars_files:
    - secrets.yml  # This file contains the encrypted passwords using Ansible Vault
  tasks:
    - name: Ensure UCS is reachable
      cisco.ucs.ucs_facts:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
      register: ucs_facts
      ignore_errors: yes

    - name: Check UCS connection status
      debug:
        msg: "UCS connection successful"
      when: ucs_facts is defined
      failed_when: ucs_facts is not defined

    - name: Fail if UCS connection failed
      fail:
        msg: "Unable to connect to UCS. Please check credentials and network."
      when: ucs_facts is not defined

    - name: Configure UCS Fabric Interconnects
      cisco.ucs.ucs_fi:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
        state: present
        fi_name: "FI-A"
        fi_model: "UCS 6332"
        fi_state: "enabled"
      register: fi_configuration
      failed_when: fi_configuration.failed
      when: ucs_facts is defined

    - name: Show UCS Fabric Interconnect Configuration Status
      debug:
        msg: "Fabric Interconnect Configuration Status: {{ fi_configuration }}"
      when: fi_configuration is defined

    - name: Configure UCS Blade Chassis
      cisco.ucs.ucs_blade:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
        state: present
        blade_id: 1
        blade_name: "Blade-1"
        blade_model: "UCS B200 M5"
      register: blade_configuration
      failed_when: blade_configuration.failed
      when: ucs_facts is defined

    - name: Show UCS Blade Configuration Status
      debug:
        msg: "Blade Configuration Status: {{ blade_configuration }}"
      when: blade_configuration is defined

    - name: Configure VLAN 10
      cisco.ucs.ucs_vlan:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
        vlan_id: 10
        vlan_name: "VLAN-10"
        state: present
      register: vlan_10_configuration
      failed_when: vlan_10_configuration.failed
      when: ucs_facts is defined

    - name: Show VLAN 10 Configuration Status
      debug:
        msg: "VLAN 10 Configuration Status: {{ vlan_10_configuration }}"
      when: vlan_10_configuration is defined

    - name: Configure VLAN 20
      cisco.ucs.ucs_vlan:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
        vlan_id: 20
        vlan_name: "VLAN-20"
        state: present
      register: vlan_20_configuration
      failed_when: vlan_20_configuration.failed
      when: ucs_facts is defined

    - name: Show VLAN 20 Configuration Status
      debug:
        msg: "VLAN 20 Configuration Status: {{ vlan_20_configuration }}"
      when: vlan_20_configuration is defined

    - name: Validate UCS Configuration
      cisco.ucs.ucs_validate:
        hostname: "{{ ucs_host }}"
        username: "{{ ucs_username }}"
        password: "{{ ucs_password }}"
      register: ucs_validation
      failed_when: ucs_validation.failed
      when: ucs_facts is defined

    - name: Show UCS Validation Status
      debug:
        msg: "UCS Configuration Validation Result: {{ ucs_validation }}"
      when: ucs_validation is defined
