# Built by: Smith, Dewain #TheBeardedEngineer
# Playbook: Basic Cohesity Deploy and Config
# Purpose: Deploy and configure a Cohesity cluster with basic settings
# Note: Read through and update variables as needed.

---
- name: Deploy and Configure Cohesity
  hosts: cohesity_cluster
  gather_facts: no
  vars:
    cohesity_username: "admin"       # Update with the Cohesity admin username
    cohesity_password: "{{ vault_cohesity_password }}"  # Use Ansible Vault for sensitive data
    cohesity_cluster_ip: "{{ inventory_hostname }}"
    cohesity_domain: "local"         # Change domain if required
    storage_domain_name: "BackupStorageDomain"
    protection_job_name: "DailyBackup"
    protection_job_policy_id: "DefaultPolicyId" # Adjust as per environment
    source_id: "SourceIdHere"        # Replace with actual source ID

  tasks:

    - name: Validate Cohesity cluster connection
      uri:
        url: "https://{{ cohesity_cluster_ip }}/irisservices/api/v1/cluster"
        method: GET
        headers:
          Accept: "application/json"
        validate_certs: no
        user: "{{ cohesity_username }}"
        password: "{{ cohesity_password }}"
      register: cluster_status
      failed_when: cluster_status.status != 200
      ignore_errors: no

    - name: Deploy storage domain
      uri:
        url: "https://{{ cohesity_cluster_ip }}/irisservices/api/v1/storageDomains"
        method: POST
        headers:
          Content-Type: "application/json"
        body:
          name: "{{ storage_domain_name }}"
          default: true
          usageType: "Backup"
        body_format: json
        validate_certs: no
        user: "{{ cohesity_username }}"
        password: "{{ cohesity_password }}"
      register: storage_domain
      failed_when: "'id' not in storage_domain.json"
      ignore_errors: no

    - name: Add protection job
      uri:
        url: "https://{{ cohesity_cluster_ip }}/irisservices/api/v1/protectionJobs"
        method: POST
        headers:
          Content-Type: "application/json"
        body:
          name: "{{ protection_job_name }}"
          environment: "kGenericNas"
          policyId: "{{ protection_job_policy_id }}"
          storageDomainId: "{{ storage_domain.json.id }}"
          sources:
            - sourceId: "{{ source_id }}"
          priority: "kMedium"
          runNow: true
        body_format: json
        validate_certs: no
        user: "{{ cohesity_username }}"
        password: "{{ cohesity_password }}"
      failed_when: "'id' not in storage_domain.json"
      ignore_errors: no

    - name: Commit configuration changes
      uri:
        url: "https://{{ cohesity_cluster_ip }}/irisservices/api/v1/commitChanges"
        method: POST
        headers:
          Content-Type: "application/json"
        validate_certs: no
        user: "{{ cohesity_username }}"
        password: "{{ cohesity_password }}"
      register: commit_status
      failed_when: commit_status.status != 200
      ignore_errors: no

    - name: Display commit status
      debug:
        var: commit_status
